<html>

<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>

<body>

  <div class="container">

    <div class="row">
      <div class="col-12">
        <canvas id="canvas" height="100%"></canvas>
      </div>
    </div>

    <div class="col-12 form-group row">

      <label for="ageNow" class="col-4 col-form-label">Age Now</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 max=150 value=30 id="ageNow">
      </div>

      <label for="ageRetire" class="col-4 col-form-label">Age Retired</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 max=150 value="60" id="ageRetired">
      </div>

      <label for="ageUntil" class="col-4 col-form-label">Age Until</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 max=150 value="80" id="ageUntil">
      </div>

      <label for="seed" class="col-4 col-form-label">Seed Fund</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 value="100000" id="seed">
      </div>

      <label for="mIncome" class="col-4 col-form-label">Monthly Income</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 value="30000" id="mIncome">
      </div>

      <label for="mExpenses" class="col-4 col-form-label">Monthly Expenses</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 value="25000" id="mExpenses">
      </div>

      <label for="returnRate" class="col-4 col-form-label">Return (%)</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 max=150 value="6" id="returnRate">
      </div>

      <label for="returnRateRetired" class="col-4 col-form-label">Return after Retirement (%)</label>
      <div class="col-8">
        <input class="form-control" type="number" min=0 max=150 value="4" id="returnRateRetired">
      </div>
      
    </div>

    </div>
  </div>





  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>



  <script>

    
    let range = (start, stop, step) => Array.from({ length: (stop - start) / step + 1 }, (_, i) => start + (i * step))


    function getElement() {
      let elementAgeNow = document.getElementById("ageNow")
      let elementAgeRetired = document.getElementById("ageRetired")
      let elementAgeUntil = document.getElementById("ageUntil")
      let elementSeed = document.getElementById("seed")
      let elementMonthInc = document.getElementById("mIncome")
      let elementMonthExp = document.getElementById("mExpenses")
      let elementReturnRate = document.getElementById("returnRate")
      let elementReturnRateRetired = document.getElementById("returnRateRetired")

      return [elementAgeNow,
        elementAgeRetired,
        elementAgeUntil,
        elementSeed,
        elementMonthInc,
        elementMonthExp,
        elementReturnRate,
        elementReturnRateRetired]
    }


    function updateRec(elements) {
      let ageNow = parseInt(elements[0].value)
      let ageRetired = parseInt(elements[1].value)
      let ageUntil = parseInt(elements[2].value)
      let seed = parseInt(elements[3].value)
      let inc = 12 * parseInt(elements[4].value)
      let exp = 12 * parseInt(elements[5].value)
      let r = 1 + Number(elements[6].value) / 100.0
      let r_retired = 1 + Number(elements[7].value) / 100.0

      let ageWork = range(ageNow, ageRetired, 1)
      let ageSpend = range(ageRetired + 1, ageUntil, 1)

      let wealthWork = Array.from({ length: ageWork.length })
      wealthWork[0] = seed
      wealthWork.slice(1).forEach((e, i) => {
        let remain = wealthWork[i] - exp
        let remainGrowth = (remain > 0 ? remain * r : remain)
        let netYearEnd = remainGrowth + inc
        wealthWork[i + 1] = netYearEnd
      })

      let wealthCarry = wealthWork[wealthWork.length - 1] - exp
      let wealthSpend = Array.from({ length: ageSpend.length })
      wealthSpend[0] = (wealthCarry > 0 ? wealthCarry * r_retired : wealthCarry)
      wealthSpend.slice(1).forEach((e, i) => {
        let remain = (wealthSpend[i] - exp) 
        let remainGrowth = (remain > 0 ? remain * r_retired : remain)
        wealthSpend[i + 1] = remainGrowth
      })

      ageRec = ageWork.concat(ageSpend)
      wealthRec = wealthWork.concat(wealthSpend)
      // console.log(ageWork)
      // console.log(ageSpend)
      // console.log(ageRec)
      // console.log(wealthWork)
      // console.log(wealthSpend)
      // console.log(wealthRec)
    }

    
    function rePlot() {
      updateRec(elements)
      chart.data.labels = ageRec
      chart.data.datasets[0].data = wealthRec
      chart.update()
    }
    
    function init() {
      updateRec(elements)

      elements.map(e => e.addEventListener("change", rePlot))
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ageRec,
          datasets: [{
            data: wealthRec,
            label: "Wealth over time",
            backgroundColor: 'rgba(0, 255, 0, 0.1)'
          }]
        },
        options: {
          tooltips: {
            callbacks: {
              label: function (tooltipItem, data) {
                
                let mil = 1000000
                if (Math.abs(tooltipItem.yLabel) >= mil) {
                  return Number(tooltipItem.yLabel / mil).toFixed(2) + ' Million'
                }

                let k = 1000
                if (Math.abs(tooltipItem.yLabel) >= k) {
                  return Number(tooltipItem.yLabel / k).toFixed(1) + 'k'
                }
                
                return Number(tooltipItem.yLabel).toFixed(0)
              }
            }
          },
          scales: {
            yAxes: [{
                ticks: {
                    // Include a dollar sign in the ticks
                    callback: function(value, index, values) {
                
                      let mil = 1000000
                      if (Math.abs(value) >= mil) {
                        return Number(value / mil) + 'Mil'
                      }

                      let k = 1000
                      if (Math.abs(value) >= k) {
                        return Number(value / k) + 'k'
                      }
                      
                      return Number(value).toFixed(0)
                    }
                }
            }]
          }
        }
      })
    }

    let ageRec, wealthRec, chart
    let ctx   = document.getElementById("canvas")
    let elements = getElement()
    init()
    

  </script>



  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

</body>

</html>